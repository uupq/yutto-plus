# YuttoDownloader 功能文档

## 概述

YuttoDownloader 是一个基于纯 HTTP API 的 B站视频下载器，完全重写了下载逻辑，不依赖 yutto CLI 输出解析。提供了 Web UI 和命令行两种使用方式。

## 当前实现的功能

### ✅ 核心下载功能

#### 🎥 视频音频下载
- **多清晰度支持**: 8K/4K/1080P60/1080P/720P/480P/360P
- **智能流选择**: 根据用户偏好自动选择最佳视频和音频流
- **并发下载**: 视频流和音频流并行下载，提高效率
- **统一进度管理**: 多流进度合并计算，避免进度条横跳
- **断点续传**: 支持分块下载和错误重试

#### 🎵 音频质量选择
- **Hi-Res**: 无损音质 (30251)
- **320kbps**: 高质量 (30280) 
- **128kbps**: 标准质量 (30232)
- **64kbps**: 低质量 (30216)

#### 🎯 视频编码支持
- **AVC/H.264**: 兼容性最佳
- **HEVC/H.265**: 更小文件体积
- **AV1**: 最新编码标准
- **智能编码选择**: 根据可用性自动选择

#### 📁 文件处理
- **FFmpeg 合并**: 自动合并音视频流
- **文件命名**: 自动清理非法字符
- **输出格式**: 支持 MP4/MKV/MOV 等格式
- **覆盖控制**: 可选择是否覆盖已存在文件

### ✅ Web UI 功能

#### 🌐 用户界面
- **现代化设计**: 响应式布局，支持各种屏幕尺寸
- **实时通信**: WebSocket 实时进度和状态更新
- **自动化启动**: 自动选择端口并打开浏览器
- **状态管理**: 准备中 → 下载中 → 合并中 → 完成

#### 📊 实时监控
- **进度条显示**: 统一的多流进度显示
- **下载速度**: 实时速度监控 (MB/s)
- **文件大小**: 当前下载量/总大小显示
- **流信息**: 立即显示选中的视频和音频流信息

#### 🔧 交互功能
- **视频预览**: 下载前预览视频信息
- **质量选择**: Web界面选择视频质量
- **错误处理**: 友好的错误信息显示
- **任务管理**: 多任务支持和状态追踪

### ✅ API 架构

#### 🏗️ 纯 API 实现
- **直接 HTTP 调用**: 绕过 yutto CLI，直接调用 B站 API
- **自定义网络层**: 使用 httpx 实现高性能异步网络
- **独立解析**: 自主实现视频信息解析和流地址获取
- **线程安全**: 多线程下载不会相互干扰

#### 🔄 回调机制
- **进度回调**: `progress_callback(current, total, speed, item_name)`
- **流信息回调**: `stream_info_callback(stream_info)` 
- **完成回调**: `completion_callback(success, result, error)`
- **状态更新**: 实时状态变化通知

#### 🎛️ 配置管理
- **默认配置**: 类级别的默认设置
- **任务覆盖**: 单次下载可覆盖默认配置
- **灵活参数**: 支持所有主要下载参数

### ✅ 编程接口

#### 📦 类设计
```python
YuttoDownloader(**config)          # 主下载器类
├── create_download_task()         # 创建下载任务  
└── DownloadTask                   # 独立下载任务
    ├── start()                    # 开始下载
    ├── get_status()              # 获取状态
    └── get_selected_streams_info() # 获取流信息
```

#### 🔧 配置选项
- `sessdata`: B站登录凭证
- `default_output_dir`: 下载目录
- `default_quality`: 视频质量 (16-127)
- `default_audio_quality`: 音频质量 (30216-30251)
- `default_video_codec`: 视频编码偏好
- `default_output_format`: 输出格式
- `overwrite`: 是否覆盖文件

## 与 yutto 功能对比

### ✅ 已实现的 yutto 功能

| 功能 | yutto | YuttoDownloader | 状态 |
|------|-------|-----------------|------|
| 视频下载 | ✅ | ✅ | 完全支持 |
| 音频下载 | ✅ | ✅ | 完全支持 |
| 清晰度选择 | ✅ | ✅ | 完全支持 |
| 编码选择 | ✅ | ✅ | 完全支持 |
| 并发下载 | ✅ | ✅ | 重新实现 |
| 进度显示 | ✅ | ✅ | 更好的体验 |
| 格式转换 | ✅ | ✅ | FFmpeg集成 |
| 文件命名 | ✅ | ✅ | 自动清理 |
| 登录验证 | ✅ | ✅ | **新增功能** |
| 会员状态显示 | ✅ | ✅ | **新增功能** |

### ❌ 尚未实现的 yutto 功能

| 功能 | yutto | YuttoDownloader | 状态 |
|------|-------|-----------------|------|
| 弹幕下载 | ✅ | ❌ | **需要实现** |
| 字幕下载 | ✅ | ❌ | **需要实现** |
| 封面下载 | ✅ | ❌ | **需要实现** |
| 章节信息 | ✅ | ❌ | **需要实现** |
| 元数据生成 | ✅ | ❌ | **需要实现** |
| 批量下载 | ✅ | ❌ | **需要实现** |
| 播放列表 | ✅ | ❌ | **需要实现** |
| 代理支持 | ✅ | ❌ | **需要实现** |
| 弹幕过滤 | ✅ | ❌ | **需要实现** |

### 🚀 YuttoDownloader 的独有优势

| 功能 | yutto | YuttoDownloader | 优势 |
|------|-------|-----------------|------|
| Web UI | ❌ | ✅ | 图形化界面 |
| 实时回调 | ❌ | ✅ | 编程友好 |
| 任务对象 | ❌ | ✅ | 面向对象 |
| 状态管理 | ❌ | ✅ | 精细控制 |
| 多流进度 | ❌ | ✅ | 更好体验 |
| 纯 API | ❌ | ✅ | 不依赖CLI |
| 自动浏览器 | ❌ | ✅ | 用户友好 |

## 功能完整性评估

### 当前完整度: **65%**

**✅ 已完成 (65%)**:
- 核心下载功能 (100%)
- Web UI 界面 (100%) 
- API 架构 (100%)
- 编程接口 (100%)
- 视频音频处理 (100%)
- 登录验证和会员状态显示 (100%)

**🔄 待完成 (35%)**:
- 弹幕/字幕/封面下载 (0%)
- 批量下载 (0%)
- 代理和高级网络 (0%)
- 弹幕处理和过滤 (0%)

## 建议实现优先级

### 🔥 高优先级 (用户强需求)
1. **封面下载** - 相对简单，用户常用
2. **弹幕下载** - B站特色功能
3. **字幕下载** - 国际化需求
4. **登录支持** - 访问高清画质

### 🟡 中优先级 (增强功能)
1. **批量下载** - 提高效率
2. **播放列表支持** - 用户便利
3. **代理支持** - 网络环境适应

### 🟢 低优先级 (高级功能)
1. **弹幕过滤** - 个性化需求
2. **元数据生成** - 媒体管理
3. **章节信息** - 高级用户需求

## 总结

YuttoDownloader 当前专注于**核心下载功能**和**用户体验**，在这两个方面已经达到或超越了 yutto 的水平。虽然在**辅助功能**(弹幕、字幕、封面等)方面还有缺失，但核心架构设计良好，易于扩展。

对于大多数用户的**基本下载需求**(视频+音频)，YuttoDownloader 已经完全满足，且提供了更好的用户体验。要达到与 yutto 相同的功能完整性，还需要补充辅助功能的实现。 